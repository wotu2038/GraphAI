version: '3.8'

services:
  neo4j:
    image: neo4j:5.26.0
    container_name: graph-ai-neo4j
    restart: unless-stopped  # 自动重启策略：除非手动停止，否则总是重启
    ports:
      - "7474:7474"  # HTTP
      - "7687:7687"  # Bolt
    # 不直接使用 env_file，避免传递 NEO4J_URI 等应用层变量给 Neo4j 容器
    # 只传递 Neo4j 容器需要的环境变量
    environment:
      # Neo4j认证：格式为 username/password
      # 从 .env 读取密码，通过环境变量传递
      - NEO4J_AUTH=neo4j/${NEO4J_PASSWORD}
      - NEO4J_PLUGINS=["apoc", "graph-data-science"]
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*,gds.*
      - NEO4J_dbms_security_procedures_allowlist=apoc.*,gds.*
      # 内存配置（Neo4j 5.26+，使用新配置项避免deprecated警告）
      # 增加内存以提升性能，支持更复杂的图算法和查询
      - NEO4J_server_memory_heap_initial__size=512m
      - NEO4J_server_memory_heap_max__size=2G
      # 页面缓存配置（增加以提升查询性能）
      - NEO4J_server_memory_pagecache_size=1G
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    healthcheck:
      # 注意：healthcheck中的密码需要与NEO4J_AUTH中的密码一致
      # 这里使用 docker compose 在解析阶段替换的变量（来自 .env 或 shell 环境）
      test: ["CMD", "cypher-shell", "-u", "neo4j", "-p", "${NEO4J_PASSWORD}", "RETURN 1"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 60s


  mysql:
    image: mysql:8.0
    container_name: graph-ai-mysql
    restart: unless-stopped  # 自动重启策略：除非手动停止，否则总是重启
    ports:
      - "3306:3306"
    env_file:
      - .env
    environment:
      # MySQL密码：生产环境请修改为强密码，可通过环境变量 MYSQL_PASSWORD 设置
      # 如果未设置环境变量，将使用占位符（需要用户手动修改）
      - MYSQL_ROOT_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-graph_ai}
      - MYSQL_USER=${MYSQL_USER:-graph_ai}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
    volumes:
      - mysql_data:/var/lib/mysql
      - ./backend/init_mysql.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      # 注意：healthcheck中的密码需要与MYSQL_ROOT_PASSWORD一致
      # 如果使用环境变量，需要确保MYSQL_PASSWORD已设置
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
    command: --default-authentication-plugin=mysql_native_password

  redis:
    image: redis:7-alpine
    container_name: graph-ai-redis
    ports:
      - "6380:6379"
    command: redis-server --requirepass ${REDIS_PASSWORD:-}
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    env_file:
      - .env

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: graph-ai-backend
    ports:
      - "8000:8000"
    env_file:
      - .env
    environment:
      # 容器间通信必需的配置（使用容器名）
      - NEO4J_URI=bolt://neo4j:7687
      - MYSQL_HOST=mysql
      - REDIS_HOST=redis
      # HuggingFace 镜像支持（加速 tokenizer 下载）
      - HF_ENDPOINT=https://hf-mirror.com
      # 其他配置从.env文件读取
    volumes:
      - ./backend:/app
    depends_on:
      neo4j:
        condition: service_healthy
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: /bin/bash /app/scripts/start_backend.sh

  celery_worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: graph-ai-celery-worker
    env_file:
      - .env
    environment:
      # 容器间通信必需的配置（使用容器名）
      - NEO4J_URI=bolt://neo4j:7687
      - MYSQL_HOST=mysql
      - REDIS_HOST=redis
      # HuggingFace 镜像支持（加速 tokenizer 下载）
      - HF_ENDPOINT=https://hf-mirror.com
      # 其他配置从.env文件读取
    volumes:
      - ./backend:/app
    depends_on:
      redis:
        condition: service_healthy
      neo4j:
        condition: service_healthy
      mysql:
        condition: service_healthy
      backend:
        condition: service_started
    command: celery -A app.core.celery_app worker --loglevel=info --concurrency=2

volumes:
  neo4j_data:
  neo4j_logs:
  mysql_data:
  redis_data:

